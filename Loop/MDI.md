# MDI智能决策助手 (MDI Agent) 设计文档

## 1. 系统概述

### 1.1 核心目标与设计原则

**MDI Agent** 是一个为采用多次每日注射（MDI）疗法的糖尿病患者设计的智能决策支持系统。它不直接控制任何硬件，而是作为一个“智能顾问”，帮助用户做出更安全、更有效的胰岛素剂量决策。

**核心目标**:

-   **剂量计算辅助**: 提供精准的餐前大剂量和高血糖纠正剂量建议。
-   **风险预警**: 基于血糖预测，提前预警潜在的高、低血糖风险。
-   **决策支持**: 为用户提供“是否需要加餐？”或“睡前血糖是否安全？”等关键问题的决策参考。
-   **长期趋势洞察**: 帮助用户和医生评估长效（基础）胰岛素的有效性。

**核心设计原则**: 安全第一、可靠可信、高度个性化、用户中心。

### 1.2 系统架构

MDI Agent是一个纯软件的分析与建议引擎，其在生态系统中的位置如下：

```
MDI Agent System Architecture:
┌───────────┐
│  CGM数据  │
└───────────┘
    │
    ▼
┌───────────────────┐   ┌───────────────────────┐
│   AI决策引擎      │──▶│     用户界面 (UI)       │
│   (MDI Agent)     │   │ (App / Smart Watch)   │
└───────────────────┘   └───────────────────────┘
    ▲                             │
    │                             ▼
    └─────────────────────────────┘
          用户输入 (进餐/运动/注射记录)
```

## 2. 核心数据模型

### 2.1 实时决策状态 (MDI_State)

```csv
字段名,数据类型,必填,中文说明,AI决策用途
glucose_value,DECIMAL_4_1,是,当前血糖值,最核心的输入
glucose_trend,TINYINT,是,血糖趋势,预测血糖变化方向
predicted_glucose,JSON,是,未来血糖预测曲线,预警和决策的核心依据
insulin_on_board,DECIMAL_5_2,是,活性胰岛素(IOB),关键安全指标，防止剂量叠加
carbs_on_board,DECIMAL_5_1,是,活性碳水(COB),估算食物的后续影响
last_injection_time,DATETIME,否,上次注射时间,防止短时内重复注射
last_injection_type,TINYINT,否,上次注射类型,"1:速效; 2:长效"
```

### 2.2 用户事件日志 (User_Event_Log)

```csv
字段名,数据类型,必填,中文说明
event_id,VARCHAR_32,是,事件ID
event_time,DATETIME,是,事件时间
event_type,TINYINT,是,事件类型,"1:进餐; 2:运动; 3:速效胰岛素注射; 4:长效胰岛素注射"
event_details,JSON,是,事件详情,"进餐:{carbs_g:50}, 注射:{units:5.5}"
```

### 2.3 MDI患者个性化配置 (Patient_Profile)

这是与Loop Agent设计**核心区别**所在，特别强调了长效和速效胰岛素的区分。

```csv
字段名,数据类型,必填,中文说明
patient_id,VARCHAR_32,是,患者ID
insulin_sensitivity_factor,JSON,是,胰岛素敏感系数(ISF),分时段设置
carb_ratio,JSON,是,碳水化合物比例(CR),分时段设置
target_glucose_range,JSON,是,目标血糖范围
rapid_acting_insulin_type,VARCHAR_20,是,速效胰岛素类型,"e.g. Novolog, Humalog"
long_acting_insulin_type,VARCHAR_20,是,长效胰岛素类型,"e.g. Lantus, Tresiba"
long_acting_insulin_dose,JSON,否,长效胰岛素常规剂量和时间,"e.g. [{time:'21:00', units:20}]"
max_bolus_recommendation,DECIMAL_4_1,是,单次最大建议推注量,安全限制
```

## 3. 核心算法设计

算法从“自动控制”简化为“智能建议”，但其核心三要素依然存在。

### 3.1 状态估计算法 (State Estimation)

此模块依然负责计算IOB、COB和血糖预测，但IOB的计算更为复杂。

-   **IOB计算**: **必须能够同时处理两种不同类型的胰岛素**。
    1.  **速效胰岛素IOB**: 采用作用时间为3-5小时的指数衰减模型，与Loop Agent类似。
    2.  **长效胰岛素IOB**: 采用作用时间为18-24小时（或更长）的、**曲线非常平坦**的模型来模拟其背景胰岛素水平。这部分IOB主要用于长期趋势分析，而非分钟级决策。
-   **COB计算** 的逻辑与Loop Agent设计基本保持一致。
-   **血糖预测 (Glucose Prediction)**：
    *   **目的**：整合所有已知信息，生成一条未来几小时（例如3-5小时）的血糖预测轨迹。这是控制算法进行决策的**唯一依据**。
    *   **计算模型**：这是算法最复杂的部分，有多种实现方式，其优劣直接影响系统性能。

| 模型方法 | 优点 | 缺点 | 适用场景 |
| :--- | :--- | :--- | :--- |
| **简单线性外推** | 实现简单，计算快 | 仅在血糖平稳时短期准确，无法预测转折点 | 作为其他模型的补充或在数据质量极差时的备用方案 |
| **生理模型+卡尔曼滤波器** | **推荐方案**。能融合IOB、COB等多个变量，预测较长期（2-3小时）且准确性高 | 实现复杂，需要精确的生理参数 | 主力预测模型，能有效预测餐后、运动等多种情况下的变化 |
| **机器学习模型(如LSTM)** | 潜力巨大，能从数据中学到复杂模式 | 需要大量高质量的个人数据进行训练，可解释性差，验证困难 | 作为高级功能或辅助模型，用于识别特定场景下的复杂模式 |

### 3.2 建议生成算法 (Recommendation Algorithm)

此模块取代了MPC，是MDI Agent的核心。它基于当前状态，通过一系列逻辑规则生成建议。

#### 1. 大剂量计算器 (Bolus Wizard)

这是最常用的功能，当用户准备进餐或纠正高血糖时触发。

-   **纠正剂量** = `(当前血糖 - 目标血糖) / ISF`
-   **餐食剂量** = `待摄入碳水 / CR`
-   **最终建议剂量** = `纠正剂量 + 餐食剂量 - IOB (仅速效部分)`
-   **安全检查**: 如果计算出的剂量 > `max_bolus_recommendation`，则发出警告。

#### 2. 风险预警与主动建议

-   **低血糖预警**: 如果预测血糖在未来30-60分钟内将低于阈值，系统会主动提醒：“**[警告]** 预测您在30分钟后可能出现低血糖，建议立即补充15克快速碳水（如葡萄糖片或果汁）。”
-   **高血糖预警**: 如果预测血糖将持续高于目标范围，系统会提示：“**[提示]** 预测您未来2小时血糖偏高。您当前的活性胰岛素(IOB)为X单位。如果需要，可以考虑追加一个小的纠正剂量。”

#### 3. 长效胰岛素评估

这是MDI Agent的一个独特价值点。

-   **机制**: Agent定期（如每周）分析过去几天的夜间或空腹血糖数据。
-   **建议示例**: “**[趋势洞察]** 分析发现，您过去7天的夜间血糖（00:00-06:00）平均值为8.5 mmol/L，持续高于目标。建议您咨询医生，讨论是否需要微调您的长效胰岛素剂量。”

### 3.3 自适应算法 (Adaptive Algorithm)

与Loop Agent类似，但更侧重于为用户提供“调参建议”而非自动修改。

-   **机制**: 通过复盘历史数据，寻找ISF和CR的系统性偏差。
-   **输出**: “**[调参建议]** 我注意到，您最近午餐后的血糖似乎总是偏高。建议您与医生讨论，是否可以将午餐的碳水比例从 1:10 调整为 1:9。”

## 4. 安全系统设计

由于不直接控制硬件，安全系统聚焦于**建议的安全性**。

1.  **IOB计算的保守性**: IOB的计算必须准确且略偏保守，这是防止剂量叠加建议的最重要防线。
2.  **硬性限制**: 所有剂量建议都不能超过用户在`Patient_Profile`中设置的最大值。
3.  **清晰的免责声明**: App的每个界面都必须有清晰的提示：“**本系统所有建议仅供参考，不能替代专业医疗意见。所有医疗决策请咨询您的医生。**”
4.  **数据有效性验证**: 当CGM数据中断或无效时，系统应暂停所有建议功能，并明确提示用户数据不可用。

## 5. 实施与验证路线图

路线图比闭环系统简化，无需硬件集成。

1.  **Phase 1: 算法核心与仿真**：开发并验证状态估计算法和建议生成逻辑的准确性。
2.  **Phase 2: 用户界面与Alpha测试**：开发用户App，进行内部小范围测试。
3.  **Phase 3: 真实世界数据验证**：招募志愿者，在“只读”模式下运行App，将其建议与用户的实际决策和医生意见进行对比，评估建议质量。
4.  **Phase 4: 上市与上市后监控**：作为医疗软件（或健康管理软件，取决于法规）发布，并持续收集数据以改进算法。
