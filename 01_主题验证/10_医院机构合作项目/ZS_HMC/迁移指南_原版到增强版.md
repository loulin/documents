# Agent_ZS CGM报告生成器：原版→增强版迁移指南

## 📌 为什么要升级？

增强版基于**GPlus CGM报告**的专业样式设计，提供了：

✅ **可视化AGP曲线** - 百分位数带状图，一目了然识别血糖模式
✅ **14天每日小图** - 快速对比每天血糖变化
✅ **HTML专业报告** - 可直接打印为PDF，无需额外工具
✅ **交互式图表** - 基于Chart.js的动态可视化
✅ **医疗级样式** - 符合临床报告规范的专业设计

---

## 🔄 代码迁移对比

### 原版用法 (v1.0)

```python
from Agent_ZS_HMC_Report_Generator import ZSHMCReportGenerator

# 创建生成器
generator = ZSHMCReportGenerator()

# 生成报告（输出JSON）
report = generator.generate_zshmc_report(
    filepath="cgm_data.csv",
    patient_id="P001",
    medication_data=medication_data,
    patient_info=patient_info
)

# 输出是一个字典
print(report["2_核心控制指标"])

# 需要额外处理才能可视化
```

### 增强版用法 (v2.0)

```python
from Agent_ZS_HMC_Report_Generator_Enhanced import generate_enhanced_report

# 一行代码生成HTML报告
html_path = generate_enhanced_report(
    filepath="cgm_data.csv",
    patient_id="P001",
    patient_info=patient_info,
    medication_data=medication_data,
    output_path="CGM_Report.html"
)

# 直接在浏览器打开，或打印为PDF
# 所有可视化已自动生成
```

---

## 📊 功能对比表

| 功能项 | 原版 v1.0 | 增强版 v2.0 |
|--------|-----------|------------|
| **输出格式** | JSON字典 | HTML文件（可打印PDF） |
| **AGP可视化** | ❌ 无 | ✅ 百分位数带状图（5/25/50/75/95%） |
| **每日血糖曲线** | ❌ 仅数据 | ✅ 14天小图网格（7x2布局） |
| **TIR分布** | 数值 | ✅ 堆叠柱状图（绿/橙/红） |
| **核心指标展示** | 文本 | ✅ 渐变色卡片设计 |
| **图表交互性** | 无 | ✅ Chart.js动态图表 |
| **可打印性** | 需要自己写代码转PDF | ✅ 浏览器Cmd+P直接打印 |
| **样式设计** | 基础 | ✅ GPlus专业医疗报告样式 |
| **响应式布局** | 无 | ✅ 适配不同屏幕尺寸 |
| **依赖库** | pandas, numpy | pandas, numpy（无需额外图表库） |

---

## 🎨 视觉效果对比

### 原版输出示例

```json
{
  "2_核心控制指标": {
    "GMI": {
      "全称": "Glucose Management Indicator",
      "当前值": "7.2%",
      "参考范围": "< 7.0% (优秀)"
    },
    "TIR": {
      "全称": "Time In Range",
      "当前值": "68.5%",
      "参考范围": "> 70% (优秀)"
    }
  }
}
```

**问题**：
- ❌ 需要自己解析JSON
- ❌ 无法直观看到血糖模式
- ❌ 不能直接交给患者或医生

---

### 增强版输出示例

**HTML报告包含**：

1. **报告头部**
   - 机构Logo区域
   - 患者信息表格
   - 监测周期和数据质量

2. **核心指标卡片**（渐变色设计）
   ```
   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
   │  平均血糖    │  │   GMI      │  │   TIR      │
   │   7.4       │  │   7.2%     │  │   68.5%    │
   │  mmol/L     │  │  目标<7.0   │  │  目标>70%   │
   └─────────────┘  └─────────────┘  └─────────────┘
   ```

3. **TIR可视化分布条**
   ```
   ████████████████████████████████████████████████████
   │ TBR 2.5% │      TIR 68.5%       │  TAR 29.0%   │
   ████████████████████████████████████████████████████
      红色          绿色                  橙色
   ```

4. **AGP动态血糖图谱**
   - 浅蓝色区域：5-95%范围
   - 深蓝色区域：25-75%范围
   - 深蓝线：中位数
   - 绿色带：目标范围（3.9-10.0）

5. **14天每日血糖曲线**（小图网格）
   ```
   2025-10-01  2025-10-02  2025-10-03  2025-10-04  ...
   [曲线图]     [曲线图]     [曲线图]     [曲线图]
   TIR: 65%    TIR: 72%    TIR: 68%    TIR: 70%
   平均: 7.2   平均: 6.8   平均: 7.5   平均: 7.1
   ```

---

## 🚀 迁移步骤

### Step 1: 备份原有代码

```bash
# 保留原版文件
cp Agent_ZS_HMC_Report_Generator.py Agent_ZS_HMC_Report_Generator_v1_backup.py
```

### Step 2: 更新导入语句

**原版代码：**
```python
from Agent_ZS_HMC_Report_Generator import ZSHMCReportGenerator
```

**改为：**
```python
from Agent_ZS_HMC_Report_Generator_Enhanced import generate_enhanced_report
```

### Step 3: 修改调用方式

**原版代码：**
```python
generator = ZSHMCReportGenerator()
report_dict = generator.generate_zshmc_report(
    filepath="data.csv",
    patient_id="P001",
    medication_data=meds,
    patient_info=info
)
# 需要手动处理JSON输出
```

**增强版代码：**
```python
html_file = generate_enhanced_report(
    filepath="data.csv",
    patient_id="P001",
    patient_info=info,
    medication_data=meds,
    output_path="report.html"  # 新增：指定输出路径
)
# 直接得到HTML文件，可在浏览器查看
```

### Step 4: 测试新功能

```python
# 生成报告
html_path = generate_enhanced_report(
    filepath="your_cgm_data.csv",
    patient_id="TEST_001",
    patient_info={"name": "测试患者", "age": 45, "gender": "男"}
)

print(f"✅ 报告已生成: {html_path}")
print("💡 在浏览器中打开查看专业可视化")

# macOS自动打开
import subprocess
subprocess.run(['open', html_path])

# Windows自动打开
# subprocess.run(['start', html_path], shell=True)
```

---

## 🔧 兼容性说明

### 数据格式

**完全兼容！** 增强版支持与原版相同的CSV格式：

```csv
timestamp,glucose_value
2025-10-01 08:00:00,5.5
2025-10-01 08:05:00,5.8
```

支持的列名变体：
- `timestamp` / `Timestamp` / `time`
- `glucose_value` / `glucose` / `Glucose` / `value`

### 参数传递

增强版支持原版的所有参数：

| 参数 | 原版 | 增强版 | 说明 |
|------|------|--------|------|
| `filepath` | ✅ | ✅ | CSV数据路径 |
| `patient_id` | ✅ | ✅ | 患者ID |
| `patient_info` | ✅ | ✅ | 患者信息字典 |
| `medication_data` | ✅ | ✅ | 用药信息 |
| `output_path` | ❌ | ✅ **新增** | HTML输出路径 |

---

## 💡 实际应用案例

### 案例1：门诊随访

**需求**：为糖尿病患者生成2周CGM随访报告

**原版做法**：
```python
# 1. 生成JSON
report = generator.generate_zshmc_report(...)

# 2. 手动提取数据
tir = report["2_核心控制指标"]["TIR"]["当前值"]

# 3. 需要自己画图或写Word文档
# 4. 工作量大，不适合批量处理
```

**增强版做法**：
```python
# 一行代码搞定
html_path = generate_enhanced_report(
    filepath="patient_001_cgm.csv",
    patient_id="P001",
    patient_info={"name": "张三", "age": 55, "gender": "男"}
)

# 在浏览器打开 → Cmd+P → 另存为PDF → 交给患者
# 耗时：< 1分钟
```

---

### 案例2：科研项目批量分析

**需求**：为100名受试者生成标准化CGM报告

**增强版批处理脚本**：
```python
import os
from Agent_ZS_HMC_Report_Generator_Enhanced import generate_enhanced_report

# 患者数据目录
data_dir = "cgm_data/"
output_dir = "reports/"

# 批量生成
for filename in os.listdir(data_dir):
    if filename.endswith('.csv'):
        patient_id = filename.replace('.csv', '')

        html_path = generate_enhanced_report(
            filepath=os.path.join(data_dir, filename),
            patient_id=patient_id,
            output_path=os.path.join(output_dir, f"{patient_id}_report.html")
        )

        print(f"✅ {patient_id} 报告生成完成")

# 所有报告都是统一格式，便于对比
```

---

## 📖 高级功能

### 1. 自定义患者信息

```python
detailed_patient_info = {
    "name": "李四",
    "age": 52,
    "gender": "女",
    "diagnosis": "2型糖尿病",
    "diabetes_duration": "10年",
    "comorbidities": ["高血压", "高脂血症"]
}

html_path = generate_enhanced_report(
    filepath="data.csv",
    patient_id="P002",
    patient_info=detailed_patient_info
)
```

### 2. 添加用药信息

```python
medication_data = {
    "medications": [
        {
            "name": "二甲双胍",
            "dosage": "500mg",
            "frequency": "bid",
            "start_date": "2024-01-01",
            "purpose": "降糖",
            "compliance": "良好"
        },
        {
            "name": "格列美脲",
            "dosage": "2mg",
            "frequency": "qd",
            "start_date": "2024-03-01",
            "purpose": "降糖",
            "compliance": "一般"
        }
    ]
}

html_path = generate_enhanced_report(
    filepath="data.csv",
    patient_id="P003",
    medication_data=medication_data
)
```

---

## 🐛 常见问题

### Q1: 能否同时使用原版和增强版？

**可以！** 两个版本互不干扰：

```python
# 原版：JSON数据供程序使用
from Agent_ZS_HMC_Report_Generator import ZSHMCReportGenerator
json_data = ZSHMCReportGenerator().generate_zshmc_report(...)

# 增强版：HTML报告供人阅读
from Agent_ZS_HMC_Report_Generator_Enhanced import generate_enhanced_report
html_path = generate_enhanced_report(...)
```

---

### Q2: HTML报告如何转PDF？

**方法1：浏览器打印（推荐）**
1. 在Chrome/Safari/Edge中打开HTML
2. 按 `Cmd+P` (Mac) 或 `Ctrl+P` (Windows)
3. 选择"另存为PDF"
4. 调整边距为"最小"，缩放100%

**方法2：命令行工具**
```bash
# 使用wkhtmltopdf
wkhtmltopdf CGM_Report.html CGM_Report.pdf

# 使用Chrome headless
chrome --headless --print-to-pdf=CGM_Report.pdf CGM_Report.html
```

---

### Q3: AGP图表显示异常？

**检查清单**：
- ✅ 网络连接正常（需加载Chart.js CDN）
- ✅ 浏览器支持（Chrome/Firefox/Safari/Edge现代版本）
- ✅ 数据点足够（建议≥3天数据）

**离线使用**：下载Chart.js到本地
```html
<!-- 修改HTML中的CDN链接为本地路径 -->
<script src="./chart.js"></script>
```

---

### Q4: 如何自定义报告样式？

生成的HTML包含完整CSS，可直接修改：

```python
# 生成报告
html_path = generate_enhanced_report(...)

# 读取并修改样式
with open(html_path, 'r', encoding='utf-8') as f:
    html = f.read()

# 修改主题色（例如改为绿色）
html = html.replace('#2196F3', '#4CAF50')  # 蓝色 → 绿色

# 保存
with open(html_path, 'w', encoding='utf-8') as f:
    f.write(html)
```

---

## 📚 参考资源

### GPlus报告样式参考

增强版基于真实GPlus CGM报告设计：
- **文件**: `郁君君-20250805.pdf`
- **关键特性**:
  - AGP百分位数带状图 (Page 1)
  - 14天每日小图布局 (Page 1下方)
  - 专业医疗报告样式

### 相关文档

- `README_Enhanced_Report.md` - 增强版完整文档
- `test_enhanced_report.py` - 测试示例
- `Agent_ZS_HMC_Report_Generator_Enhanced.py` - 源代码

---

## ✅ 迁移检查清单

- [ ] 已备份原版代码
- [ ] 已更新导入语句
- [ ] 已修改函数调用方式
- [ ] 已测试HTML报告生成
- [ ] 已验证浏览器显示正常
- [ ] 已测试PDF打印功能
- [ ] 已确认所有可视化正常显示

---

## 🎉 总结

增强版报告生成器保持了**100%向后兼容**，同时提供：

✨ **更专业** - GPlus医疗级样式设计
✨ **更直观** - AGP和每日曲线可视化
✨ **更便捷** - 一行代码生成完整报告
✨ **更高效** - 浏览器打印即可导出PDF

**推荐使用场景**：
- 门诊患者随访报告 ✅
- 健康管理中心报告 ✅
- 临床研究数据展示 ✅
- 科研论文插图生成 ✅

---

**版本**: v2.0 Enhanced Migration Guide
**更新日期**: 2025-10-09
**基于**: GPlus CGM Report Template
