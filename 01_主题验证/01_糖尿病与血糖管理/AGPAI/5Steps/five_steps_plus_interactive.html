<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº”æ­¥æ³•Plus - æ™ºèƒ½å­¦ä¹ CGMåˆ†æç³»ç»Ÿ</title>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        .content {
            display: flex;
            height: 80vh;
        }
        .left-panel {
            flex: 1;
            padding: 20px;
            border-right: 1px solid #eee;
        }
        .right-panel {
            flex: 1;
            padding: 20px;
        }
        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .file-upload {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
        }
        .file-upload input {
            margin: 10px 0;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #5a6fd8;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .editor-container {
            height: 400px;
            margin-bottom: 20px;
        }
        .status-bar {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .changes-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .change-item {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            border-radius: 3px;
        }
        .original-text {
            color: #dc3545;
            text-decoration: line-through;
            font-size: 12px;
        }
        .modified-text {
            color: #28a745;
            font-weight: bold;
            font-size: 12px;
        }
        .patient-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>äº”æ­¥æ³•Plus - æ™ºèƒ½å­¦ä¹ CGMåˆ†æç³»ç»Ÿ</h1>
            <p>AIç”Ÿæˆå»ºè®® + åŒ»ç”Ÿæ™ºæ…§ä¿®æ”¹ = æŒç»­ä¼˜åŒ–çš„ä¸´åºŠå†³ç­–æ”¯æŒ</p>
        </div>
        
        <div class="content">
            <!-- å·¦ä¾§é¢æ¿ï¼šæ•°æ®è¾“å…¥å’ŒAIåˆ†æ -->
            <div class="left-panel">
                <div class="panel-title">ğŸ“Š æ•°æ®åˆ†æ</div>
                
                <div class="file-upload">
                    <div>ä¸Šä¼ CGMæ•°æ®æ–‡ä»¶</div>
                    <input type="file" id="fileInput" accept=".xlsx,.csv" />
                    <div>
                        <button class="btn" onclick="analyzeData()">å¼€å§‹AIåˆ†æ</button>
                        <button class="btn btn-warning" onclick="loadSampleData()">ä½¿ç”¨ç¤ºä¾‹æ•°æ®</button>
                    </div>
                </div>
                
                <div class="patient-info" id="patientInfo" style="display:none;">
                    <h4>æ‚£è€…ä¿¡æ¯</h4>
                    <div id="patientDetails"></div>
                </div>
                
                <div class="loading" id="loadingPanel">
                    <div class="spinner"></div>
                    <p>AIæ­£åœ¨åˆ†æCGMæ•°æ®...</p>
                </div>
                
                <div class="status-bar" id="statusBar">
                    <strong>çŠ¶æ€ï¼š</strong> ç­‰å¾…æ•°æ®ä¸Šä¼ 
                </div>
                
                <div class="changes-panel" id="changesPanel" style="display:none;">
                    <div class="panel-title">ğŸ“ ä¿®æ”¹è®°å½•</div>
                    <div id="changesList"></div>
                </div>
            </div>
            
            <!-- å³ä¾§é¢æ¿ï¼šå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
            <div class="right-panel">
                <div class="panel-title">âœï¸ æŠ¥å‘Šç¼–è¾‘ä¸ä¼˜åŒ–</div>
                
                <div class="status-bar">
                    <strong>ç¼–è¾‘æ¨¡å¼ï¼š</strong> 
                    <span id="editMode">ç­‰å¾…AIç”Ÿæˆåˆå§‹å»ºè®®</span>
                    <button class="btn btn-success" id="saveBtn" onclick="saveReport()" style="float:right; display:none;">
                        ä¿å­˜æœ€ç»ˆæŠ¥å‘Š
                    </button>
                </div>
                
                <!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
                <div class="editor-container">
                    <div id="editor"></div>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn" onclick="previewReport()" id="previewBtn" style="display:none;">
                        é¢„è§ˆæŠ¥å‘Š
                    </button>
                    <button class="btn btn-success" onclick="generateFinalReport()" id="finalBtn" style="display:none;">
                        ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
        var quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    ['clean']
                ]
            }
        });

        // å…¨å±€å˜é‡
        let originalReport = '';
        let currentPatientData = null;
        let changeHistory = [];

        // ç›‘å¬ç¼–è¾‘å™¨å†…å®¹å˜åŒ–
        quill.on('text-change', function(delta, oldDelta, source) {
            if (source === 'user' && originalReport) {
                detectChanges();
            }
        });

        // ä½¿ç”¨ç¤ºä¾‹æ•°æ®
        function loadSampleData() {
            updateStatus('åŠ è½½ç¤ºä¾‹æ•°æ®...');
            
            // æ¨¡æ‹Ÿç¤ºä¾‹æ‚£è€…æ•°æ®
            currentPatientData = {
                patientId: 'å•å¹¿ä»-92098',
                fileName: 'ç¤ºä¾‹æ•°æ®',
                analysisTime: new Date().toLocaleString('zh-CN'),
                wearDays: 14.0,
                validDataPct: 99.6,
                standardTir: 88.6,
                strictTir: 58.5,
                lenientTir: 97.9,
                meanGlucose: 7.96,
                tbr: 0.1,
                cv: 26.6,
                strictTar: 41.4
            };
            
            showPatientInfo();
            analyzeWithSampleData();
        }

        // AIåˆ†æå‡½æ•°
        function analyzeData() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files.length && !currentPatientData) {
                alert('è¯·å…ˆä¸Šä¼ CGMæ•°æ®æ–‡ä»¶æˆ–ä½¿ç”¨ç¤ºä¾‹æ•°æ®');
                return;
            }
            
            showLoading(true);
            updateStatus('AIæ­£åœ¨ç”Ÿæˆäº”æ­¥æ³•åˆ†ææŠ¥å‘Š...');
            
            // æ¨¡æ‹ŸAIåˆ†æè¿‡ç¨‹
            setTimeout(function() {
                generateAIReport();
            }, 2000);
        }

        // ä½¿ç”¨ç¤ºä¾‹æ•°æ®åˆ†æ
        function analyzeWithSampleData() {
            showLoading(true);
            updateStatus('AIæ­£åœ¨åˆ†æç¤ºä¾‹æ•°æ®...');
            
            setTimeout(function() {
                generateAIReport();
            }, 1500);
        }

        // ç”ŸæˆAIæŠ¥å‘Š
        function generateAIReport() {
            const reportContent = `
            <h2>AGP æŠ¥å‘Šåˆ†å±‚è¯„ä¼°è§£è¯»: v3.0</h2>
            <hr>
            <p><strong>æ‚£è€…ID:</strong> ${currentPatientData.patientId}<br>
            <strong>åˆ†ææ—¶é—´:</strong> ${currentPatientData.analysisTime}<br>
            <strong>è¡€ç³–ç®¡ç†ç­‰çº§:</strong> è¡€ç³–æ§åˆ¶äºšä¼˜ï¼Œéœ€è¦è°ƒæ•´<br>
            <strong>è¯„ä¼°ç±»å‹:</strong> ä¸¥æ ¼è¯„ä¼°<br>
            <strong>ä¸»è¦å»ºè®®:</strong> éœ€è¦å¼ºåŒ–ç”Ÿæ´»æ–¹å¼ç®¡ç†<br>
            <strong>éšè®¿é¢‘ç‡:</strong> æœˆåº¦ç›‘æµ‹</p>
            <hr>

            <h3>ä¸€. æ•°æ®è´¨é‡è¯„ä¼°</h3>
            <p>1. ä½©æˆ´å¤©æ•°: <strong>${currentPatientData.wearDays} å¤©</strong> (æ ‡å‡†: â‰¥14å¤©)<br>
            2. æœ‰æ•ˆæ•°æ®: <strong>${currentPatientData.validDataPct}%</strong> (æ ‡å‡†: â‰¥70%)<br>
            3. è¯„ä¼°ç»“è®º: <strong>æ•°æ®å……åˆ†å¯ä¿¡</strong></p>

            <h3>äºŒ. åˆ†å±‚è¡€ç³–è¾¾æ ‡è¯„ä¼°</h3>
            <h4>ä¸‰å±‚ç›®æ ‡èŒƒå›´TIRå¯¹æ¯”</h4>
            <p>1. <strong>æ ‡å‡†TIR (3.9-10.0 mmol/L): ${currentPatientData.standardTir}%</strong> (ç³–å°¿ç—…ç›®æ ‡: >70%)<br>
            2. <strong>ä¸¥æ ¼TIR (3.9-7.8 mmol/L): ${currentPatientData.strictTir}%</strong> (ä»£è°¢å¥åº·ç›®æ ‡: >80%)<br>
            3. <strong>å®½æ¾TIR (3.9-13.9 mmol/L): ${currentPatientData.lenientTir}%</strong> (åŸºç¡€å®‰å…¨ç›®æ ‡: >50%)<br>
            4. <strong>å¹³å‡è‘¡è„ç³–: ${currentPatientData.meanGlucose} mmol/L</strong></p>

            <h4>åˆ†å±‚è¯„ä¼°ç»“æœ</h4>
            <p>1. <strong>è¯„ä¼°è·¯å¾„:</strong> æ ‡å‡†TIR â‰¥ 70%ï¼Œå¯åŠ¨ä¸¥æ ¼è¯„ä¼°<br>
            2. <strong>ä¸¥æ ¼è¯„ä¼°ç­‰çº§:</strong> è¡€ç³–æ§åˆ¶äºšä¼˜ï¼Œéœ€è¦è°ƒæ•´<br>
            3. <strong>ä¸´åºŠæ„ä¹‰:</strong> è¡€ç³–æ§åˆ¶è‰¯å¥½ï¼ŒæŒ‰ä»£è°¢å¥åº·äººç¾¤æ ‡å‡†è¯„ä¼°</p>

            <h3>ä¸‰. ä½è¡€ç³–é£é™©è¯„ä¼°</h3>
            <p>1. <strong>TBR (&lt;3.9 mmol/L): ${currentPatientData.tbr}%</strong> (å®‰å…¨ç›®æ ‡: &lt;4%)<br>
            2. <strong>ä½è¡€ç³–é£é™©:</strong> è¾ƒä½ï¼Œä½è¡€ç³–é£é™©è¾ƒä½</p>

            <h3>å››. è¡€ç³–ç¨³å®šæ€§è¯„ä¼°</h3>
            <p>1. <strong>è¡€ç³–å˜å¼‚ç³»æ•° (CV): ${currentPatientData.cv}%</strong> (ç†æƒ³ç›®æ ‡: â‰¤36%)<br>
            2. <strong>ç¨³å®šæ€§:</strong> å°šå¯ï¼Œè¡€ç³–æ³¢åŠ¨åœ¨ä¸´åºŠå¯æ¥å—èŒƒå›´å†…</p>

            <h3>äº”. é«˜è¡€ç³–è´Ÿæ‹…è¯„ä¼° (ä¸¥æ ¼æ ‡å‡†)</h3>
            <p>1. <strong>TAR (>7.8 mmol/L): ${currentPatientData.strictTar}%</strong> (ä»£è°¢å¥åº·ç›®æ ‡: <20%)<br>
            2. <strong>é«˜è¡€ç³–è´Ÿæ‹…:</strong> åé«˜ï¼Œå»ºè®®è°ƒæ•´ç”Ÿæ´»æ–¹å¼</p>

            <h3>ç»¼åˆè¯„ä¼°ä¸å»ºè®®</h3>
            <p>1. <strong>æœ€ç»ˆè¯„çº§:</strong> è¡€ç³–æ§åˆ¶äºšä¼˜ï¼Œéœ€è¦è°ƒæ•´<br>
            2. <strong>ä¸»è¦å»ºè®®:</strong> éœ€è¦å¼ºåŒ–ç”Ÿæ´»æ–¹å¼ç®¡ç†<br>
            3. <strong>éšè®¿è®¡åˆ’:</strong> æœˆåº¦ç›‘æµ‹<br>
            4. <strong>ä¸‹æ¬¡CGM:</strong> å»ºè®®4å‘¨å</p>

            <hr>
            <p><strong>åˆ†å±‚è¯„ä¼°æŠ¥å‘Šç”Ÿæˆå®Œæ¯•</strong><br>
            <strong>å…è´£å£°æ˜:</strong> æœ¬æŠ¥å‘Šä»…ä¾›ä¸´åºŠå‚è€ƒï¼Œå…·ä½“æ²»ç–—æ–¹æ¡ˆè¯·éµåŒ»å˜±</p>
            `;

            // å°†AIç”Ÿæˆçš„æŠ¥å‘ŠåŠ è½½åˆ°ç¼–è¾‘å™¨
            quill.root.innerHTML = reportContent;
            originalReport = reportContent;
            
            showLoading(false);
            updateStatus('AIåˆ†æå®Œæˆï¼Œè¯·åœ¨å³ä¾§ç¼–è¾‘å™¨ä¸­ä¿®æ”¹å»ºè®®');
            document.getElementById('editMode').textContent = 'å¯ä»¥å¼€å§‹ä¿®æ”¹AIå»ºè®®';
            document.getElementById('saveBtn').style.display = 'inline-block';
            document.getElementById('previewBtn').style.display = 'inline-block';
            document.getElementById('finalBtn').style.display = 'inline-block';
        }

        // æ˜¾ç¤ºæ‚£è€…ä¿¡æ¯
        function showPatientInfo() {
            const patientInfo = document.getElementById('patientInfo');
            const patientDetails = document.getElementById('patientDetails');
            
            patientDetails.innerHTML = `
                <p><strong>æ‚£è€…ID:</strong> ${currentPatientData.patientId}</p>
                <p><strong>æ–‡ä»¶å:</strong> ${currentPatientData.fileName}</p>
                <p><strong>åˆ†ææ—¶é—´:</strong> ${currentPatientData.analysisTime}</p>
            `;
            
            patientInfo.style.display = 'block';
        }

        // æ£€æµ‹ä¿®æ”¹
        function detectChanges() {
            const currentContent = quill.root.innerHTML;
            if (currentContent !== originalReport) {
                // è¿™é‡Œå¯ä»¥å®ç°æ›´å¤æ‚çš„diffç®—æ³•
                const changeCount = changeHistory.length + 1;
                addChangeRecord(`ä¿®æ”¹ #${changeCount}`, originalReport, currentContent);
            }
        }

        // æ·»åŠ ä¿®æ”¹è®°å½•
        function addChangeRecord(title, original, modified) {
            const change = {
                timestamp: new Date().toLocaleString('zh-CN'),
                title: title,
                original: original,
                modified: modified
            };
            
            changeHistory.push(change);
            displayChanges();
        }

        // æ˜¾ç¤ºä¿®æ”¹è®°å½•
        function displayChanges() {
            const changesPanel = document.getElementById('changesPanel');
            const changesList = document.getElementById('changesList');
            
            if (changeHistory.length > 0) {
                changesPanel.style.display = 'block';
                
                changesList.innerHTML = changeHistory.map((change, index) => `
                    <div class="change-item">
                        <strong>${change.title}</strong>
                        <small style="float:right; color:#666;">${change.timestamp}</small>
                        <div style="margin-top:8px;">
                            <div class="original-text">åŸæ–‡: ${change.original.substring(0, 100)}...</div>
                            <div class="modified-text">ä¿®æ”¹: ${change.modified.substring(0, 100)}...</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // ä¿å­˜æŠ¥å‘Š
        function saveReport() {
            const finalContent = quill.root.innerHTML;
            
            // è®°å½•æœ€ç»ˆä¿®æ”¹
            if (finalContent !== originalReport) {
                addChangeRecord('æœ€ç»ˆç‰ˆæœ¬', originalReport, finalContent);
            }
            
            // è¿™é‡Œå¯ä»¥å‘é€åˆ°åç«¯ä¿å­˜
            console.log('ä¿å­˜æœ€ç»ˆæŠ¥å‘Š:', {
                patientId: currentPatientData.patientId,
                originalReport: originalReport,
                finalReport: finalContent,
                changes: changeHistory
            });
            
            alert('æŠ¥å‘Šå·²ä¿å­˜ï¼ä¿®æ”¹è®°å½•å·²è®°å½•ç”¨äºç³»ç»Ÿå­¦ä¹ ä¼˜åŒ–ã€‚');
        }

        // é¢„è§ˆæŠ¥å‘Š
        function previewReport() {
            const content = quill.root.innerHTML;
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                <head>
                    <title>CGMåˆ†ææŠ¥å‘Šé¢„è§ˆ</title>
                    <style>
                        body { font-family: Microsoft YaHei, Arial, sans-serif; padding: 20px; }
                        h2, h3, h4 { color: #333; }
                        hr { margin: 20px 0; }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `);
        }

        // ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
        function generateFinalReport() {
            saveReport();
            previewReport();
        }

        // æ›´æ–°çŠ¶æ€æ 
        function updateStatus(message) {
            document.getElementById('statusBar').innerHTML = `<strong>çŠ¶æ€ï¼š</strong> ${message}`;
        }

        // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        function showLoading(show) {
            document.getElementById('loadingPanel').style.display = show ? 'block' : 'none';
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('ç³»ç»Ÿå·²å°±ç»ªï¼Œè¯·ä¸Šä¼ CGMæ•°æ®æˆ–ä½¿ç”¨ç¤ºä¾‹æ•°æ®å¼€å§‹åˆ†æ');
        });
    </script>
</body>
</html>