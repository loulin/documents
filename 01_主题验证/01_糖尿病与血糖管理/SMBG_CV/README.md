# 指尖血糖数据处理脚本使用说明

## 项目简介

这个Python脚本用于处理多个患者的指尖血糖（SMBG）数据，支持CSV格式的数据导入和分析。**现在支持多日数据跟踪和分析**，可以对同一患者的多天测量数据进行统计分析。

## 文件结构

```
SMBG_CV/
├── smbg_data_processor.py    # 主要处理脚本
├── sample_data.csv          # 示例数据文件
└── README.md               # 使用说明（本文件）
```

## CSV数据格式要求

### 列名（按顺序）：
1. **案例编号** - 患者唯一标识符
2. **日期** - 测量日期或序号（新增）
3. **凌晨** - 凌晨血糖值
4. **早餐前** - 早餐前血糖值
5. **早餐后** - 早餐后血糖值
6. **午餐前** - 午餐前血糖值
7. **午餐后** - 午餐后血糖值
8. **晚餐前** - 晚餐前血糖值
9. **晚餐后** - 晚餐后血糖值
10. **睡前** - 睡前血糖值
11. **随机** - 随机时间血糖值（包含时间和数值）

### 数据要求：
- **编码格式**: UTF-8
- **分隔符**: 逗号(,)
- **案例编号**: 字符串，相同编号表示同一患者
- **日期**: 支持多种格式
  - `D1`, `D2`, `D3` （推荐格式）
  - `Day1`, `Day2`, `Day3`
  - `第1天`, `第2天`, `第3天`
  - `2023-12-31`, `2023/12/31` （实际日期）
- **血糖值**: 数字，单位为mmol/L
- **缺失数据**: 留空或使用空字符串
- **随机列格式**: 支持多种格式
  - `14:30:7.2;18:45:6.8` (多个测量，用分号分隔)
  - `14:30 7.2` (时间 血糖值)
  - `7.2@14:30` (血糖值@时间)

## 功能特性

### 血糖管理指标（10个核心参数）
基于国际血糖监测指南的标准化指标：

1. **测量天数**: 患者的实际测量天数
2. **测量覆盖率(%)**: 有数据的测量占应测量次数的占比(每日8次)
3. **平均葡萄糖(mmol/L)**: 所有血糖测量的平均值
4. **目标范围内时间TIR(%)**: 葡萄糖在3.9-10.0 mmol/L范围内的时间占比
5. **GMI葡萄糖管理指标(%)**: 基于平均血糖估算的糖化血红蛋白值
6. **1级低血糖TBR(%)**: 葡萄糖在3.0-3.8 mmol/L范围的占比
7. **2级低血糖TBR(%)**: 葡萄糖<3.0 mmol/L的占比
8. **变异系数CV(%)**: 血糖变异程度指标
9. **1级高血糖TAR(%)**: 葡萄糖在10.1-13.9 mmol/L范围的占比
10. **2级高血糖TAR(%)**: 葡萄糖>13.9 mmol/L的占比

### 1. 数据解析功能
- 自动解析CSV文件（支持11列新格式）
- 处理缺失数据
- 解析随机血糖列的复杂格式
- 按患者编号分组处理
- **多日数据处理**: 支持同一患者的多天数据跟踪
- **灵活的日期格式**: 支持D1/D2/D3或实际日期格式

### 2. 血糖分析功能
- **统计指标计算**:
  - 平均值、中位数
  - 标准差、变异系数(CV)
  - 最小值、最大值、范围
- **血糖水平分类**:
  - 低血糖 (< 3.9 mmol/L)
  - 正常 (3.9-6.1/7.8 mmol/L)
  - 糖尿病前期 (6.1-7.0/7.8-11.1 mmol/L)
  - 糖尿病范围 (>7.0/11.1 mmol/L)
- **多日分析**（新增）:
  - 日间变异系数（评估血糖控制的稳定性）
  - 血糖趋势分析（上升/下降/稳定）
  - 各日详细统计和总体汇总
- **血糖管理指标**（新增）:
  - **10个核心参数**: 基于国际血糖监测指南
  - 每日和整个测量时间段的计算
  - TIR/TBR/TAR时间在范围指标
  - GMI葡萄糖管理指标估算

### 3. 报告生成功能
- **详细结果** (JSON格式，包含多日分析和血糖管理参数)
- **汇总报告** (JSON格式)  
- **患者统计表** (CSV格式，新增多日指标和10个血糖管理参数)

## 使用方法

### 1. 基本使用

```python
from smbg_data_processor import SMBGDataProcessor

# 创建处理器
processor = SMBGDataProcessor('your_data.csv')

# 加载并处理数据
processor.load_data()
processor.process_all_data()

# 保存结果
processor.save_results()
```

### 2. 高级使用

```python
# 获取汇总报告
summary = processor.generate_summary_report()
print(f"总患者数: {summary['total_patients']}")
print(f"总测量次数: {summary['total_measurements']}")

# 访问单个患者数据
for patient in processor.processed_data:
    print(f"患者 {patient['patient_id']}")
    print(f"平均血糖: {patient['statistics']['mean']} mmol/L")
    print(f"变异系数: {patient['statistics']['cv']}%")
```

### 3. 命令行运行

```bash
cd /Users/williamsun/Documents/gplus/docs/SMBG_CV
python smbg_data_processor.py
```

## 输出文件说明

运行脚本后会生成以下文件：

### 1. smbg_detailed_results.json
包含每个患者的详细分析结果：
- 各时间点血糖统计
- 随机测量记录
- 血糖分布统计
- 总体统计指标
- 每日血糖管理参数分析
- 整体血糖管理指标

### 2. smbg_summary_report.json  
整体汇总报告：
- 总患者数和测量次数
- 各时间点覆盖率
- 总体血糖统计
- 血糖分布汇总
- 血糖管理整体指标氇总

### 3. patient_summary.csv
患者汇总表格，包含：
- 基本统计（均值、中位数、标准差等）
- 各时间点测量次数和平均值
- 血糖水平分布计数
- 变异系数等质量指标
- **多日指标**（新增）：
  - 测量天数
  - 日间变异系数
  - 血糖趋势方向
  - 日间平均变化
- **血糖管理指标**（新增）：
  - 10个独立的血糖管理参数列
  - **显示整个测量周期的沇总数据**
  - 包括测量覆盖率、TIR/TBR/TAR指标等
  - 每日详细数据可在JSON文件中查看
- **血糖管理指标**（新增）：
  - 10个独立的血糖管理参数
  - 包括测量覆盖率、TIR/TBR/TAR指标等
  - 支持每日和整体时间段的计算

## 示例数据说明

`sample_data.csv` 包含5个患者的多日示例数据：
- P001: 3天数据 (D1-D3)，有随机测量
- P002: 2天数据 (D1-D2)，有随机测量  
- P003: 3天数据 (D1-D3)，多个随机测量
- P004: 1天数据 (D1)，有随机测量
- P005: 1天数据 (D1)，有随机测量

## 注意事项

1. **数据质量**: 确保CSV文件格式正确，编码为UTF-8，**现在需要含11列数据**
2. **血糖单位**: 脚本假设血糖值单位为mmol/L
3. **日期格式**: 支持D1/D2/D3或实际日期，同一患者可有多天数据
4. **时间格式**: 随机列中的时间支持HH:MM格式
5. **内存使用**: 大数据文件可能消耗较多内存
6. **错误处理**: 脚本会记录解析错误但继续处理

## 依赖包

```bash
pip install pandas numpy
```

## 扩展功能建议

## 血糖管理参数层次示例

以患者P002为例，展示每日参数与整个测量周期参数的区别：

### 每日参数 (daily_data)
```json
"D1": {
  "gmi_parameters": {
    "measurement_coverage": 125.0,
    "average_glucose": 6.17,
    "time_in_range": 90.0,
    "gmi": 5.97,
    "level1_hypoglycemia": 10.0,  // D1日有低血糖
    "cv": 26.33
  }
},
"D2": {
  "gmi_parameters": {
    "measurement_coverage": 112.5,
    "average_glucose": 6.2,
    "time_in_range": 100.0,
    "gmi": 5.98,
    "level1_hypoglycemia": 0.0,   // D2日无低血糖
    "cv": 28.51
  }
}
```

### 整个测量周期参数 (gmi_parameters)
```json
"gmi_parameters": {
  "measurement_days": 2,
  "measurement_coverage": 118.75,  // 两天平均覆盖率
  "average_glucose": 6.18,         // 两天总体平均值
  "time_in_range": 94.74,          // 两天总体TIR
  "gmi": 5.98,
  "level1_hypoglycemia": 5.26,     // 两天汇总低血糖比例
  "cv": 26.62
}
```

### 使用场景
- **每日参数**: 用于分析患者的日间血糖变化规律，发现特定日期的问题
- **整个周期参数**: 用于患者的整体血糖管理评估和临床决策

## 扩展功能建议

可以进一步扩展的功能：
- 生成可视化图表（多日趋勿图）
- 添加更多血糖质量指标
- 支持更多时间格式
- 导出Excel格式报告
- 更精细的多日趋勿分析
- 集成AGP报告生成
- 按周/月的时间段分析
- 多患者比較分析