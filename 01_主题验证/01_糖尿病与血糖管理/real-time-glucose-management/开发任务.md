# Context
Filename: 开发任务.md
Created On: 2025-01-27 16:30:00
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
开发患者血糖实时管理系统，通过风险评估算法对患者进行分级管理，实现血糖数据的实时监控和医患沟通功能。主要包括：
1. 患者信息录入与风险评估表单页面
2. 实时监控大屏四级风险分区显示
3. 医生建议系统

**关键修复事项**：
1. 风险计算安全性：修复缺失字段导致的计算错误，添加完整的容错处理
2. 基本信息编辑：在表单中显示并支持编辑患者基本信息
3. 纵向布局：实时管理页面改为四个风险区纵向排列，极高风险在最上方
4. 二维码显示：在表单底部添加授权和支付二维码展示（使用qr-kefu.jpg占位）
5. 药品录入：使用简单表单组件实现药品有/无选择
6. 数据源规范：使用queryInpatient API获取演示患者数据
7. 卡片样式：参考BigScreen2实现血糖曲线+患者信息布局
8. **新增** 风险评分归一化：根据最新的`190模式v1.1`规则，实现评分归一化算法，并更新风险分层标准。
9. **新增** 患病年数字段：补充缺失的患病年数评分参数。
10. **新增** GDM特殊处理：仅在妊娠期内计算GDM相关评分。
11. **新增** 生活方式详细评分：实现反向计分的生活方式评估系统（饮食4分+运动3分+吸烟饮酒3分）
12. **新增** 区间划分规则：文档中明确所有数值区间采用左闭右开原则

# Project Overview
基于现有的血糖管理系统，新增实时管理模块。项目使用React + TypeScript + Ant Design + Pro Components技术栈，需要迁移现有的患者分类评分算法，并创建新的实时管理界面。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

## 现有代码结构分析
1. **患者列表页面** (`client/src/pages/Patient/List.tsx`)：
   - 使用ProTable展示患者数据
   - TableDropdown提供操作菜单，需要在此添加"加入实时管理"入口
   - 已有完整的患者数据获取和操作逻辑

2. **路由配置** (`client/config/routes.ts`)：
   - 采用嵌套路由结构
   - 需要在主路由层级添加新的实时管理路由
   - 导航菜单通过menuDataRender渲染

3. **评分算法模块** (`client/src/pages/RealTimeManagement/algorithms/scoring/`)：
   - 包含8个核心评分算法文件：cgm.ts, medication.ts, complications.ts等
   - 有完整的类型定义和测试文件
   - 通过index.ts统一导出所有算法接口

4. **血糖数据展示** (`client/src/pages/Dashboard/BigScreen2/Simple.tsx`)：
   - 使用useRequest轮询获取血糖数据
   - ReactEcharts显示血糖曲线
   - TIR/TBR/TAR计算和展示逻辑
   - api.patient.queryInpatient获取患者数据

5. **药品录入参考** (`client/src/pages/Form/MedicationEdit.tsx`)：
   - EditableProTable实现可编辑表格
   - 药物类型、剂量、频次等字段管理
   - 完整的增删改查功能

## 技术要求确认
- 前端框架：React + TypeScript + Ant Design Pro
- 数据存储：localStorage暂存风险评估结果
- 权限控制：机构管理员(isManager)
- 国际化：仅中文支持
- 服务器端：暂不开发，专注前端演示

## 关键技术依赖
- @ant-design/pro-table：数据表格
- @ant-design/pro-form：表单组件
- @ant-design/pro-layout：页面布局
- echarts-for-react：血糖图表
- qrcode.react：二维码生成(需新增)

# Proposed Solution (Populated by INNOVATE mode)

## 选定架构：模块化分离架构

### 核心设计决策
1. **独立模块设计**：在`client/src/pages/`下创建与Patient平级的RealTimeManagement模块
2. **localStorage数据存储**：风险评估结果存储在浏览器本地，适合演示需求
3. **组件复用策略**：复用现有血糖图表和表单组件，确保UI一致性

### 模块结构设计
```
client/src/pages/RealTimeManagement/
├── index.tsx                   # 实时管理主页面 - 四级风险分区
├── PatientRiskForm.tsx         # 患者风险评估表单页面
├── algorithms/                 # 迁移的风险评估算法
│   ├── scoring/               # 评分算法目录(完整迁移)
│   └── __tests__/             # 对应测试文件
├── components/                # 专用组件
│   ├── RiskLevelSection.tsx   # 风险等级区域组件
│   ├── PatientCard.tsx        # 患者信息卡片
│   ├── AdviceModal.tsx        # 医生建议模态框
│   └── QRCodeDisplay.tsx      # 二维码展示组件
├── types/                     # 类型定义
└── utils/                     # 工具函数
```

### 技术实现方案
1. **表单实现**：ProForm + 分区块设计 + 实时评分计算 + 容错处理
2. **血糖图表**：复用BigScreen2的ReactEcharts配置
3. **轮询更新**：1分钟间隔获取血糖数据更新
4. **权限控制**：导航菜单添加isManager权限检查
5. **二维码生成**：新增qrcode.react依赖
6. **纵向布局**：四个风险区域从上到下排列
7. **药品录入**：EditableProTable实现可编辑表格

### 数据流设计
- **输入**：表单收集→算法计算→风险分级→localStorage存储
- **展示**：localStorage读取→血糖数据获取→分区展示→实时更新
- **交互**：建议编辑→发送状态→用户反馈

# Implementation Plan (Generated by PLAN mode)

## 详细实现规格

### 1. 项目基础框架搭建
**路由配置更新** (`client/config/routes.ts`)：
- 在主菜单层级添加实时管理路由，位置在patient-classification之后
- 添加权限控制：`access: 'canManage'`
- 配置风险评估表单子路由

**导航菜单国际化** (`client/src/locales/zh-CN/menu.ts`)：
- 添加 `'menu.real-time-management': '实时管理'`
- 添加 `'menu.patient-risk-assessment': '风险评估'`

### 2. 算法模块
**综合评分计算器创建**：
- 实现综合风险计算函数，集成 `190模式风险分层生成规则.md` 中定义的所有算法。
- **新增：实现风险评分归一化**：
  - `原始总分 = Σ(参数得分 × 权重)`
  - `归一化总分 = (原始总分 / 75.2) * 100`
- 实现新的风险等级分类。基于归一化后的总分 (0-100分) 进行划分:
  - **低风险**: < 25
  - **中等风险**: 25 - 50
  - **高风险**: 50 - 75
  - **极高风险**: > 75
- **重要**：添加完整的容错处理，确保缺失字段不导致计算错误

### 3. 患者列表页面改造
- 在TableDropdown菜单中添加"加入实时管理"选项
- 实现跳转到风险评估表单的导航逻辑

### 4. 风险评估表单页面
- 使用ProForm + PageContainer布局
- **基本信息可编辑**：显示患者已有数据并支持编辑
- 实现7个信息录入区块的表单设计
- **药品录入表格**：参考MedicationEdit.tsx使用EditableProTable
- 集成安全的风险评估算法（容错处理）
- **二维码展示**：表单底部添加授权和支付二维码（使用qr-kefu.jpg占位）

### 5. 实时管理主页面
- **纵向布局**：四级风险分区从上到下排列（极高风险在最上方）
- **患者卡片**：参考BigScreen2实现血糖曲线 + 基本信息布局
- **演示数据**：从api.patient.queryInpatient获取前三个患者数据
- 轮询机制：1分钟间隔数据更新

### 6. 医生建议功能
- ModalForm实现建议编辑
- 发送渠道选择和状态反馈

### 7. 类型定义和工具函数
- 风险评估数据类型定义
- localStorage存储工具函数

### 8. 演示数据生成
- 3个极高风险演示患者数据
- 模拟血糖曲线数据

## Implementation Checklist:
- [x] 1. 基础框架搭建 (目录、路由、菜单配置)
- [x] 2. 算法模块迁移
- [x] 3. 风险评估入口添加
- [ ] 4. **核心算法更新**：
  - [ ] 实现基于190模式v1.1规则的风险归一化计算（原始总分/75.2×100）
  - [ ] 更新风险分级标准（低风险<25，中等25-50，高风险50-75，极高>75）
  - [ ] 添加GDM特殊处理逻辑（仅妊娠期内计算GDM分数）
  - [ ] 补充患病年数字段的评分算法
  - [ ] **已确认**：生活方式0-10分的详细反向计分规则实现（饮食4分+运动3分+吸烟饮酒3分，权重0.5，分数越高越差）
- [ ] 5. **风险评估表单开发**：
  - [ ] 实现表单整体布局及7个信息录入区块
  - [ ] **关键实现**: 确保患者基本信息可编辑
  - [ ] **新增字段**: 患病年数输入和评分
  - [ ] **关键实现**: 使用简单表单组件实现药品有/无选择（四类药物：降糖药、胰岛素、降压药、降脂药）
  - [ ] **关键实现**: 在表单底部展示授权和支付二维码
  - [ ] **已确认**: GDM分期的自动计算逻辑（基于预产期：早期EDD前24-28周，中期EDD前12-4周，晚期EDD前4周至产后6周）
- [ ] 6. **实时管理主页面开发**：
  - [ ] **关键实现**: 搭建四级风险分区纵向布局（极高风险在最上方）。
  - [ ] **关键实现**: 重构患者卡片，包含血糖曲线和基本信息。
  - [ ] 实现轮询更新机制，并使用`queryInpatient`作为演示数据源。
- [ ] 7. **医生建议功能开发** (模态框、发送逻辑及状态反馈)。
- [ ] 8. **收尾工作** (类型定义、工具函数、依赖安装、测试、优化)。

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> 已完成步骤3，正在开始步骤4：核心算法更新

# Task Progress (Appended by EXECUTE mode after each step completion)
* 2025-01-27 16:45:00
  * Step: 1. 创建RealTimeManagement模块目录结构
  * Modifications: 创建了完整的目录结构包括algorithms、components、types、utils等
  * Change Summary: 建立了实时管理模块的基础框架
  * Reason: 执行计划步骤1
  * Blockers: None
  * Status: Success

* 2025-01-27 16:46:00
  * Step: 2. 配置路由：添加实时管理主页面和风险评估表单页面路由
  * Modifications: 在client/config/routes.ts中添加了real-time-management和patient-risk-assessment路由
  * Change Summary: 新增实时管理相关路由配置，支持主页面和表单页面
  * Reason: 执行计划步骤2
  * Blockers: None
  * Status: Success

* 2025-01-27 16:47:00
  * Step: 3. 配置导航菜单：添加国际化文件和权限控制
  * Modifications: 在client/src/locales/zh-CN/menu.ts中添加了菜单国际化配置
  * Change Summary: 添加了"实时管理"和"患者风险评估"的中文菜单标签
  * Reason: 执行计划步骤3
  * Blockers: None
  * Status: Success

* 2025-01-27 16:48:00
  * Step: 4. 迁移算法模块：复制scoring目录的8个算法文件到新模块
  * Modifications: 复制了PatientClassification/algorithms/scoring的所有文件到RealTimeManagement/algorithms/scoring
  * Change Summary: 成功迁移了8个评分算法文件和相关测试文件
  * Reason: 执行计划步骤4
  * Blockers: None
  * Status: Success

* 2025-01-27 16:50:00
  * Step: 5. 创建综合评分计算器：集成所有算法实现风险分级
  * Modifications: 创建了client/src/pages/RealTimeManagement/algorithms/riskCalculator.ts文件
  * Change Summary: 实现了综合风险评分计算器，包含风险等级分类和建议生成
  * Reason: 执行计划步骤5
  * Blockers: None
  * Status: Success

* 2025-01-27 16:52:00
  * Step: 6. 修改患者列表页面：在TableDropdown中添加"加入实时管理"入口
  * Modifications: 在client/src/pages/Patient/List.tsx的handleMore函数和TableDropdown menus中添加了新选项
  * Change Summary: 患者列表现在支持"加入实时管理"操作，点击后跳转到风险评估表单
  * Reason: 执行计划步骤6
  * Blockers: None
  * Status: Success

# Final Review (Populated by REVIEW mode) 