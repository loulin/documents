# 癌症病史循环录入逻辑设计

## 📋 整体设计理念

癌症病史采用**"主控制表 + 详情表"**的设计模式，支持用户选择一个癌症部位后填写完整的详细信息，然后循环添加其他癌症部位，直到所有需要记录的癌症部位都录入完毕。

## 🗃️ 数据表结构

### 1. 主控制表：`cancer_history_control`
- **作用**：控制整个癌症病史录入流程
- **核心字段**：
  - `has_cancer`：是否患有或曾经患有癌症（必选）
  - `total_cancer_sites`：已录入的癌症部位总数（自动计算）
  - `cancer_entry_completed`：癌症病史录入完成确认

### 2. 详情表：`cancer_detail`
- **作用**：存储每个癌症部位的详细信息
- **支持**：同一患者的多个癌症部位记录
- **核心字段**：
  - `site_sequence`：部位序号（自动递增）
  - `cancer_site`：癌症部位（23种标准部位）
  - 诊断信息、治疗详情、当前状态、生活影响等

## 🔄 用户界面录入流程

### 第一步：癌症筛查
```
问题：您是否患有或曾经患有癌症？
选项：□ 有  □ 无
```

**如果选择"无"**：
- 跳过所有癌症相关问题
- 进入下一个疾病部分

**如果选择"有"**：
- 进入癌症部位详细录入流程

### 第二步：第一个癌症部位录入
```
现在请填写第1个癌症部位的详细信息：

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                第1个癌症部位信息录入
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【基本信息】
癌症部位：[下拉选择] ▼
  □ 1.大脑     □ 2.口腔     □ 3.喉       □ 4.咽
  □ 5.甲状腺   □ 6.肺       □ 7.乳房     □ 8.食管
  □ 9.胃       □ 10.肝脏    □ 11.胰腺    □ 12.肾脏
  □ 13.前列腺  □ 14.睾丸    □ 15.卵巢    □ 16.子宫颈
  □ 17.子宫内膜 □ 18.结肠直肠 □ 19.膀胱   □ 20.皮肤
  □ 21.非霍奇金淋巴瘤 □ 22.白血病 □ 23.其他器官

（如选择"其他器官"）
具体部位：[_________________________]

癌症类型：[_________________________] (可选)
诊断年份：[____] 年
诊断时年龄：[___] 岁

【病理信息】
癌症分期：□ 早期  □ 中期  □ 晚期  □ 不详
癌症分级：□ 高分化  □ 中分化  □ 低分化  □ 未分化  □ 不详
转移情况：□ 无转移  □ 局部转移  □ 远处转移  □ 不详

（如有转移）
转移部位：□ 肺  □ 肝  □ 骨  □ 脑  □ 淋巴结  □ 其他部位

与家族史相关：□ 是  □ 否

【治疗信息】
手术治疗：□ 是  □ 否
  （是）手术年份：[____] 年
       手术类型：[_________________________]

化学治疗：□ 是  □ 否
  （是）化疗方案：[_________________________]

放射治疗：□ 是  □ 否
  （是）放疗详情：[_________________________]

靶向治疗：□ 是  □ 否
  （是）靶向药物：[_________________________]

免疫治疗：□ 是  □ 否
  （是）免疫药物：[_________________________]

中医治疗：□ 是  □ 否
  （是）中医详情：[_________________________]

【当前状态】
目前状态：□ 完全缓解  □ 部分缓解  □ 稳定  □ 进展  □ 复发  □ 不详
最后随访：[____]-[__]-[__] 日期
目前治疗：□ 是  □ 否
  （是）治疗详情：[_________________________]

治疗副作用：□ 恶心呕吐  □ 疲乏  □ 脱发  □ 骨髓抑制
           □ 神经毒性  □ 心脏毒性  □ 肝功能异常
           □ 肾功能异常  □ 皮肤反应  □ 其他副作用

（如选择"其他副作用"）
其他副作用：[_________________________]

【生活影响】
日常生活影响：□ 无影响  □ 轻度影响  □ 中度影响  □ 重度影响  □ 不详
工作能力影响：□ 无影响  □ 轻度影响  □ 中度影响  □ 重度影响
             □ 完全无法工作  □ 不详
心理影响：□ 无影响  □ 轻度焦虑抑郁  □ 中度焦虑抑郁
         □ 重度焦虑抑郁  □ 不详

备注：[________________________________________________]

[保存第1个癌症部位信息]
```

### 第三步：循环录入控制
```
第1个癌症部位（肺癌）信息已保存。

您是否还有其他部位的癌症需要录入？

□ 是，继续添加下一个癌症部位
□ 否，癌症病史录入完成

[继续添加] [录入完成]
```

**如果选择"继续添加"**：
- 系统自动递增序号：`site_sequence = 2`
- 显示"现在请填写第2个癌症部位的详细信息"
- 重复上述详细录入表单
- 继续循环直到用户选择"录入完成"

**如果选择"录入完成"**：
- 系统设置 `cancer_entry_completed = true`
- 自动计算 `total_cancer_sites` 总数
- 进入下一个疾病部分

### 第四步：进度提示与确认
```
✅ 癌症病史录入完成
   已录入 2 个癌症部位：
   1. 肺癌（2018年诊断，目前稳定）
   2. 乳腺癌（2020年诊断，完全缓解）

继续录入下一个疾病...
```

## 💻 技术实现要点

### 1. 数据库设计
```sql
-- 主控制表
INSERT INTO cancer_history_control (patient_id, has_cancer, cancer_entry_completed)
VALUES ('patient_123', true, false);

-- 详情表支持多条记录
INSERT INTO cancer_detail (patient_id, site_sequence, cancer_site, diagnosis_year, ...)
VALUES 
  ('patient_123', 1, 6, 2018, ...),  -- 第1个部位：肺癌
  ('patient_123', 2, 7, 2020, ...);  -- 第2个部位：乳腺癌
```

### 2. 前端交互逻辑
```javascript
// 伪代码
function addCancerSite() {
  let currentSequence = getCurrentSiteCount() + 1;
  
  showCancerSiteForm({
    title: `现在请填写第${currentSequence}个癌症部位的详细信息`,
    sequence: currentSequence,
    onSave: (cancerData) => {
      saveCancerData(cancerData);
      showContinueDialog();
    }
  });
}

function showContinueDialog() {
  const completedSites = getCompletedCancerSites();
  
  showDialog({
    message: `第${completedSites.length}个癌症部位信息已保存。您是否还有其他部位的癌症需要录入？`,
    currentProgress: completedSites.map(site => `${site.sequence}. ${site.siteName}`),
    buttons: [
      {
        text: "是，继续添加下一个癌症部位",
        action: () => addCancerSite()
      },
      {
        text: "否，癌症病史录入完成",
        action: () => {
          markCancerEntryCompleted();
          moveToNextSection();
        }
      }
    ]
  });
}
```

### 3. 数据验证规则
- **必填字段验证**：癌症部位、目前状态必须填写
- **逻辑一致性验证**：选择"其他器官"时，具体部位必填
- **治疗逻辑验证**：选择某种治疗为"是"时，相关详情字段需要填写
- **重复性检查**：同一癌症部位不应重复录入
- **完整性验证**：确保用户明确表示录入完成

### 4. 用户体验优化
- **进度提示**：显示当前录入第几个癌症部位
- **数据回显**：已录入癌症部位的信息可查看和修改
- **智能提示**：根据癌症部位提供相应的治疗选项
- **暂存功能**：支持未完成录入的暂时保存

## 🎯 业务场景示例

### 场景1：多部位癌症患者
```
患者张三的癌症病史：
1. 肺癌 - 2018年诊断 - 晚期 - 已手术+化疗 - 目前稳定
2. 乳腺癌 - 2020年诊断 - 早期 - 已手术 - 完全缓解
3. 皮肤癌 - 2021年诊断 - 早期 - 已手术 - 完全缓解

录入流程：选择"有癌症" → 录入肺癌详情 → 继续添加 → 录入乳腺癌详情 → 
继续添加 → 录入皮肤癌详情 → 录入完成
```

### 场景2：无癌症病史
```
患者李四的癌症病史：
癌症：无 → 直接跳过整个癌症病史部分
```

### 场景3：单一癌症
```
患者王五的癌症病史：
1. 甲状腺癌 - 2019年诊断 - 早期 - 已手术 - 完全缓解

录入流程：选择"有癌症" → 录入甲状腺癌详情 → 选择"录入完成"
```

## 📊 数据字段详解

### A. 基本诊断信息（H8A-H8B1）
- **癌症部位**：23种标准部位选择 + 其他器官自定义
- **癌症类型**：具体的病理类型描述
- **诊断信息**：诊断年份、诊断时年龄

### B. 病理特征（H8C-H8E）
- **癌症分期**：早期/中期/晚期/不详
- **癌症分级**：高分化/中分化/低分化/未分化/不详
- **转移情况**：无转移/局部转移/远处转移/不详
- **转移部位**：多选支持（肺/肝/骨/脑/淋巴结/其他）
- **家族史相关**：是否与家族遗传史相关

### C. 治疗信息（H8F-H8K1）
- **手术治疗**：是否手术、手术年份、手术类型
- **化学治疗**：是否化疗、化疗方案
- **放射治疗**：是否放疗、放疗详情
- **靶向治疗**：是否靶向治疗、靶向药物
- **免疫治疗**：是否免疫治疗、免疫药物
- **中医治疗**：是否中医治疗、中医方案

### D. 当前状态（H8L-H8N1）
- **目前状态**：完全缓解/部分缓解/稳定/进展/复发/不详
- **随访信息**：最后随访日期
- **当前治疗**：是否仍在治疗、治疗详情
- **治疗副作用**：多选支持10种常见副作用

### E. 生活影响（H8O-H8Q）
- **日常生活影响**：无影响到重度影响的5级评估
- **工作能力影响**：包括完全无法工作的6级评估
- **心理影响**：焦虑抑郁程度的5级评估

## 🔍 统计分析支持

### 数据统计查询
```sql
-- 统计各部位癌症患病情况
SELECT 
  cancer_site,
  COUNT(*) as case_count,
  AVG(diagnosis_age) as avg_diagnosis_age,
  COUNT(CASE WHEN current_status IN (1,2) THEN 1 END) as remission_count
FROM cancer_detail
GROUP BY cancer_site
ORDER BY case_count DESC;

-- 分析治疗方式效果
SELECT 
  CASE 
    WHEN received_surgery = 1 AND received_chemotherapy = 1 THEN '手术+化疗'
    WHEN received_surgery = 1 AND received_radiotherapy = 1 THEN '手术+放疗'
    WHEN received_surgery = 1 THEN '仅手术'
    ELSE '其他'
  END as treatment_combination,
  current_status,
  COUNT(*) as case_count
FROM cancer_detail
GROUP BY treatment_combination, current_status;
```

### 生存分析支持
```sql
-- 为生存分析准备数据
SELECT 
  patient_id,
  cancer_site,
  diagnosis_year,
  diagnosis_age,
  cancer_stage,
  current_status,
  CASE WHEN current_status IN (4,5) THEN 1 ELSE 0 END as event_occurred,
  (YEAR(CURRENT_DATE) - diagnosis_year) as followup_years
FROM cancer_detail
WHERE diagnosis_year IS NOT NULL;
```

这种设计完全满足了您的需求：**选择一个癌症部位后填写完整详细信息，然后支持循环添加其他癌症部位，直到所有需要记录的癌症部位都填写完毕**。同时提供了全面的癌症病史管理功能，支持复杂的临床研究和患者管理需求。