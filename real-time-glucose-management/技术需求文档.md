# 患者血糖实时管理系统 - 技术需求文档

## 项目概述

### 项目目标
开发一套患者血糖实时管理系统，通过风险评估算法对患者进行分级管理，实现血糖数据的实时监控和医患沟通功能。

### 核心功能
1. **患者信息录入与风险评估**：基于多维度数据计算患者风险等级
2. **实时监控大屏**：四级风险分区显示患者血糖曲线
3. **医生建议系统**：支持医生编辑和发送患者建议

## 技术架构设计

### 1. 项目结构
```
client/src/pages/
├── Patient/
│   └── List.tsx                    # 现有患者列表（新增入口）
└── RealTimeManagement/             # 新建实时管理模块（与Patient平级）
    ├── index.tsx                   # 实时管理主页面
    ├── PatientRiskForm.tsx         # 患者风险评估表单页面
    ├── algorithms/                 # 风险评估算法模块（迁移自PatientClassification）
    │   ├── scoring/                # 评分算法
    │   └── __tests__/              # 对应测试文件
    ├── components/                 # 组件目录
    │   ├── RiskLevelSection.tsx    # 风险等级区域组件
    │   ├── PatientCard.tsx         # 患者信息卡片
    │   ├── AdviceModal.tsx         # 医生建议模态框
    │   └── QRCodeDisplay.tsx       # 二维码展示组件
    ├── types/                      # 类型定义
    └── utils/                      # 工具函数
```

### 2. 路由设计
```typescript
// 新增路由配置
{
  path: '/real-time-management',
  name: 'RealTimeManagement',
  component: './RealTimeManagement',
},
{
  path: '/patient/:patientId/assessment',
  name: 'PatientRiskAssessment', 
  component: './RealTimeManagement/PatientRiskForm',
}
```

### 3. 导航菜单配置
在主导航菜单中添加"实时管理"入口，位置在管理员视图后面，权限要求为机构管理员（isManager）。

## 详细功能设计

### 1. 患者列表页面改造 (client/src/pages/Patient/List.tsx)

#### 1.1 操作列新增入口
在现有操作列的TableDropdown中新增"加入实时管理"选项，点击后跳转到风险评估表单页面进行患者信息录入和风险评估。

### 2. 患者风险评估表单页面 (PatientRiskForm.tsx)

#### 2.1 页面功能
- 通过路由参数获取患者ID，调用api.patient.get获取患者基本信息
- 设计表单收集风险评估所需的详细信息
- **安全的风险评分计算**：当表单字段不完整时，缺失部分按0分处理，避免计算错误
- 展示第三方传感器授权二维码和支付二维码

#### 2.2 表单字段设计
参考现有评分算法参数，表单分为以下几个区块：

**基本信息区块**
- **患者数据展示和编辑**：复用患者已有数据（姓名、性别、年龄、病程、诊断），但需要在表单中显示并支持编辑
- **补充信息**：身高、体重、BMI（根据身高体重计算）
- **患病年数**：糖尿病患病年限（<5年、5-10年、10-20年、>20年），权重0.5

参考文件：`client/src/pages/RealTimeManagement/algorithms/scoring/patientCharacteristics.ts`

**CGM血糖指标区块**  
- 综合TIR/TBR/TAR百分比和低血糖事件次数
- 1周、昨日、今日的TIR/TBR/TAR数据
- CV值、MAGE值、HbA1c水平、趋势箭头

参考文件：`client/src/pages/RealTimeManagement/algorithms/scoring/cgm.ts`

**低血糖事件详情**
- **评分依据**: 根据 `190模式` 规则，评分主要依据低血糖事件的发生频率（例如：是否 >= 1次/周）。
- **数据收集**: 表单可收集更详细信息（如严重程度、发生时段）用于临床参考，但评分仅使用频率。

参考文件：`client/src/pages/RealTimeManagement/algorithms/scoring/hypoglycemia.ts`

**并发症信息**
- 高血压 (>130/80 mmHg)
- 高血脂 (LDL-C>2.6 mmol/L, 非孕期)
- 肾病 (ACR>30 mg/g)
- 心血管疾病 (有心梗史)

参考文件：`client/src/pages/RealTimeManagement/algorithms/scoring/complications.ts`

**生活方式信息**
- **数据收集**:
  - **饮食习惯**: 主食GI值评估（低/中/高GI为主）+ 饮食均衡度（优/良/差）
  - **运动习惯**: 运动强度和频率综合评估（积极规律/偶有活动/活动不足/久坐不动）
  - **其他风险习惯**: 吸烟情况（从不/已戒烟/目前吸烟）+ 饮酒情况（从不或浅酌/规律或过量）
- **评分规则**:
  - 根据 `190模式` 规则，采用**反向计分**，分数越高生活方式越差，汇总为0-10分的原始分。
  - **详细计分标准**:
    - **饮食习惯 (满分4分)**: 
      - 主食GI值 (满分2分): 低GI为主(0分), 中GI为主(1分), 高GI为主(2分)
      - 饮食均衡度 (满分2分): 优/科学均衡(0分), 良/基本均衡(1分), 差/严重失衡(2分)
    - **运动习惯 (满分3分)**: 积极规律(0分), 偶有活动(1分), 活动不足(2分), 久坐不动(3分)
    - **其他风险习惯 (满分3分)**: 
      - 吸烟情况 (满分2分): 从不吸烟(0分), 已戒烟>1年(1分), 目前吸烟(2分)
      - 饮酒情况 (满分1分): 从不或仅社交性浅酌(0分), 规律性/过量饮酒(1分)
  - **最终得分**: (原始得分/10)×2，权重0.5
  - **分类标准**: 原始分0-4分归类为"良好"，5-10分归类为"差"

参考文件：`client/src/pages/RealTimeManagement/algorithms/scoring/lifestyle.ts`

**妊娠相关信息（仅GDM患者）**
- **预产期输入**：手动输入预产期
- **妊娠阶段自动计算**：根据预产期和当前日期计算妊娠阶段
  - 无GDM、妊娠早期（EDD前24-28周）、妊娠中期（EDD前12-4周）、妊娠晚期（EDD前4周至产后6周）
- **评分规则**：诊断为GDM时权重1.0，妊娠期内生效，否则按0分处理
- **容错处理**：非GDM患者或产后6周后，GDM相关分数按0分计算

参考文件：`client/src/pages/RealTimeManagement/algorithms/scoring/pregnancy.ts`

**用药信息**
- **简化药物录入**: 根据 `190模式` 规则，采用简单的有/无选择，支持以下四类药物：
  - **降糖药**: 有/无（权重0.5，有=2分）
  - **胰岛素**: 有/无（权重0.5，有=2分）
  - **降压药**: 有/无（权重0.5，有=2分）
  - **降脂药**: 有/无（权重0.5，有=2分）
- **实现方式**: 使用ProFormRadio.Group或ProFormCheckbox，无需复杂的可编辑表格
- **评估重点**: 专注于药物类型的有无，而非具体的剂量和频次

参考文件：`client/src/pages/RealTimeManagement/algorithms/scoring/medication.ts`

**注意**：移除复杂的MedicationEdit.tsx参考，改用简单的表单组件实现药物有/无选择。

#### 2.3 二维码展示
- **第三方传感器授权**：展示硅基和微泰两个授权二维码，使用`client/src/assets/qr-kefu.jpg`作为占位图
- **授权二维码位置**：在表单提交按钮上方显示
- **支付二维码**：根据计算出的风险等级显示相应的服务费用支付二维码
- **支付二维码显示方式**：表单提交完成后弹出模态框显示风险评估结果和支付二维码

### 3. 风险评估算法集成 (algorithms/)

#### 区间划分规则
**重要说明**: 除非特别指明，所有数值区间均采用**左闭右开**原则，即包含左端点，不包含右端点。
例如："7-8%"表示 [7%, 8%)，即 7% ≤ 值 < 8%。

#### 3.1 综合评分计算器
基于 `190模式风险分层生成规则.md v1.1` 创建综合风险计算器，实现完整的评分公式。

- **原始总分计算**:
  - `原始总分 = Σ(参数得分 × 权重)`
  - 详细的参数、得分和权重严格遵循 `190模式风险分层生成规则.md` v1.1版。
- **分数归一化**:
  - 为了使评分结果更具可比性，将原始总分归一化到100分制。
  - 根据v1.1规则，理论上的最高原始总分为 **75.2**。
  - `归一化总分 = (原始总分 / 75.2) × 100`
- **容错处理**：对于缺失或未填写的字段，该部分的参数得分按0处理，确保计算不会出错。
  - CGM数据缺失（CV、MAGE、TIR/TBR等）：按0分处理
  - 生活方式信息不完整：部分缺失时按现有信息计算，完全缺失按0分处理
  - 并发症和用药信息缺失：默认按无（0分）处理
- **GDM特殊处理**：诊断为GDM的患者，仅在妊娠期内计算GDM相关分数，非妊娠期按0分处理。

参考文件：`client/src/pages/RealTimeManagement/algorithms/scoring/index.ts`（所有算法的导出入口）

#### 3.2 风险等级分类
基于 `190模式风险分层生成规则.md v1.1` 的最新标准，风险等级基于 **归一化后** 的总分 (0-100分) 进行划分：
- **低风险**: 总分 < 25
- **中等风险**: 总分 25 - 50  
- **高风险**: 总分 50 - 75
- **极高风险**: 总分 > 75

**归一化计算公式**：
- 原始总分 = Σ(参数得分 × 权重)
- 归一化总分 = (原始总分 / 75.2) × 100
- 其中75.2为理论最高原始总分

### 4. 实时管理主页面 (index.tsx)

#### 4.1 页面功能
- 获取已评估风险的患者列表，1分钟轮询更新
- **数据源规范**：优先从api.patient.queryInpatient获取前三个患者作为演示数据
- 调用血糖数据API获取患者最近的血糖信息
- **纵向排列**：按风险等级将患者分组显示在四个纵向排列的区域中，从上到下依次为：极高风险、高风险、一般风险、低风险

参考文件：`client/src/pages/Dashboard/BigScreen2/Simple.tsx`（血糖数据获取和展示逻辑）

#### 4.2 四级风险分区布局
- **纵向单列布局**：四个风险区域从上到下排列
- **极高风险区**：红色标识，位于最上方
- **高风险区**：橙色标识，位于第二位
- **一般风险区**：黄色标识，位于第三位  
- **低风险区**：绿色标识，位于最下方

#### 4.3 患者卡片功能
- **血糖曲线展示**：参考BigScreen2/Simple.tsx的实现，显示最近24小时血糖数据的小图表
- **患者基本信息**：姓名、性别、年龄、糖尿病类型
- **布局设计**：上半部分为血糖曲线，下半部分为患者信息
- **卡片排列方式**：流式布局，从左到右排列，不够时自动换行到下一行
- **交互功能**：
  - 点击血糖曲线查看完整图表详情
  - 点击发送建议按钮弹出医生建议编辑框

参考文件：
- `client/src/pages/Dashboard/BigScreen2/chart.ts`（血糖图表配置）
- `client/src/pages/Glucose/Days.tsx`（完整血糖图表展示）

#### 4.4 医生建议功能
- 支持医生编辑文本建议内容
- 选择发送渠道（微信推送、短信、App推送）
- 发送状态反馈和错误处理

## 数据模型设计

### 1. 患者风险信息扩展
在患者模型中新增风险评估相关字段：
- 风险等级（low/moderate/high/extreme）
- 风险评分数值
- 评估日期
- CGM指标数据
- 并发症信息
- 生活方式信息
- 妊娠信息（GDM患者）
- 用药信息

**数据存储**：风险评估结果暂存在localStorage中，便于演示和测试。

### 2. 医生建议数据模型
包含建议内容、发送渠道、状态跟踪等字段，支持建议历史查询和状态管理。

## API接口设计

### 1. 风险评估相关接口
- 保存风险评估结果到患者记录
- 获取已评估风险的实时管理患者列表

### 2. 医生建议相关接口  
- 发送建议到患者（支持多种渠道）
- 查询患者建议历史记录

## 演示数据方案

### 1. 模拟风险评估患者
**数据来源**：从api.patient.queryInpatient获取前三个患者，设置为极高风险状态，其他风险等级区域暂时保持空白状态。

### 2. 血糖数据生成
复用现有BigScreen2的血糖数据获取逻辑，为演示患者生成血糖曲线数据。

## 开发计划

### 基础框架搭建
- [x] 创建RealTimeManagement模块目录结构
- [x] 配置路由（实时管理主页面和风险评估表单页面）
- [x] 配置导航菜单项（管理员权限，位置在管理员视图后面）
- [x] 患者列表页面添加"加入实时管理"入口

### 风险评估算法集成  
- [x] 迁移PatientClassification/algorithms/scoring到新模块
- [x] 创建综合评分计算器
- [x] 实现风险等级分类逻辑

### 风险评估表单页面
- [ ] 搭建表单页面框架
- [ ] **修复风险计算错误**：添加字段完整性检查和容错处理
- [ ] **基本信息可编辑**：显示患者数据并支持编辑
- [ ] 实现各个信息录入区块
- [ ] **药品录入表格**：参考MedicationEdit.tsx实现可编辑表格
- [ ] 集成安全的风险评估算法
- [ ] **二维码展示**：在表单底部添加授权和支付二维码

### 实时管理主页面
- [ ] **纵向布局**：修改为四个风险区纵向排列，极高风险在最上方
- [ ] **患者卡片重构**：参考BigScreen2实现血糖曲线+患者信息布局
- [ ] 集成血糖数据获取和图表展示
- [ ] **演示数据**：从queryInpatient获取前三个患者数据
- [ ] 实现轮询更新机制

### 医生建议功能
- [ ] 实现建议编辑模态框
- [ ] 添加发送渠道选择
- [ ] 完成发送状态反馈

### 演示数据和优化
- [ ] 生成极高风险演示患者数据
- [ ] 界面样式优化和响应式适配
- [ ] 整体功能测试和bug修复

## 技术依赖

### 现有依赖复用
- React + TypeScript + Ant Design + Pro Components
- ECharts血糖图表组件
- 现有API服务架构（client/src/services）
- 现有患者分类评分算法

### 新增依赖
- QR Code生成库：`qrcode.react`

---

## 核心参考文件列表

### 评分算法相关
- `client/src/pages/RealTimeManagement/algorithms/scoring/index.ts` - 所有评分算法的统一导出
- `client/src/pages/RealTimeManagement/algorithms/scoring/patientCharacteristics.ts` - 患者特征评分
- `client/src/pages/RealTimeManagement/algorithms/scoring/cgm.ts` - CGM血糖指标评分
- `client/src/pages/RealTimeManagement/algorithms/scoring/hypoglycemia.ts` - 低血糖事件评分
- `client/src/pages/RealTimeManagement/algorithms/scoring/complications.ts` - 并发症评分
- `client/src/pages/RealTimeManagement/algorithms/scoring/lifestyle.ts` - 生活方式评分
- `client/src/pages/RealTimeManagement/algorithms/scoring/pregnancy.ts` - 妊娠阶段评分
- `client/src/pages/RealTimeManagement/algorithms/scoring/medication.ts` - 药物评分

### 血糖数据展示相关
- `client/src/pages/Dashboard/BigScreen2/Simple.tsx` - 患者列表和血糖数据获取逻辑
- `client/src/pages/Dashboard/BigScreen2/chart.ts` - 血糖图表配置
- `client/src/pages/Glucose/Days.tsx` - 完整血糖图表展示

### 表单实现参考
- ~~`client/src/pages/Form/MedicationEdit.tsx`~~ - ❌ 过于复杂，不适合风险评估表单
- **改用**：ProFormRadio.Group 或 ProFormCheckbox 实现简单的药物有/无选择

### API服务
- `client/src/services/api` - 现有API服务（患者数据、血糖数据等）

### 资源文件
- `client/src/assets/qr-kefu.jpg` - 二维码占位图

## 关键修复事项

1. **风险计算安全性**：修复缺失字段导致的计算错误，添加完整的容错处理
2. **基本信息编辑**：在表单中显示并支持编辑患者基本信息
3. **纵向布局**：实时管理页面改为四个风险区纵向排列
4. **二维码显示**：在表单底部添加授权和支付二维码展示
5. **药品录入**：使用简单表单组件实现药品有/无选择
6. **数据源规范**：使用queryInpatient API获取演示患者数据
7. **卡片样式**：参考BigScreen2实现血糖曲线+患者信息布局

## 开发要求确认

- ✅ **算法迁移**：仅迁移scoring目录
- ✅ **导航菜单**：添加到主导航，位置在管理员视图后面
- ✅ **权限控制**：机构管理员权限（isManager）
- ✅ **数据存储**：localStorage暂存风险评估结果
- ✅ **国际化**：暂不支持，仅中文
- ✅ **服务器端**：暂不开发，专注前端演示实现

此技术文档为患者血糖实时管理系统的完整实现方案，涵盖了所有核心功能模块的详细设计和开发计划。 🩺 

## 新增功能需求

### FR3.2: 血糖报告中应包含可配置的每日血糖目标范围，并以不同颜色清晰标注TIR、TAR、TBR。

### FR4: 风险评估与预警
- **FR4.1**: 系统应能根据患者的实时和历史数据，计算其低血糖和高血糖风险指数。
- **FR4.2**: 当风险指数超过阈值时，系统应能通过App推送、短信等方式向患者或医护人员发送预警。

### FR5: AI驱动的个性化健康建议
- **FR5.1**: 系统应提供一个API接口，接收患者的综合健康数据（包括基本信息、诊断、身体指标、CGM数据等）。
- **FR5.2**: 系统后端应能够将结构化的患者数据，结合预设的专家提示词（System Prompt），格式化为适合大型语言模型（LLM）处理的输入。
- **FR5.3**: 系统应能调用外部AI服务（如火山引擎豆包大模型），生成个性化的糖尿病管理建议。
- **FR5.4**: 返回的建议应结构清晰，包含对患者当前健康状况的评估、血糖数据分析以及可执行的行动计划。
- **FR5.5**: 提示词（Prompt）不应硬编码，应支持从配置文件或数据库加载，以实现未来的动态管理。 