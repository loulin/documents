# 智能数据录入助手 (Agent) 设计方案

---

## 1. 问题定义

在当前的医疗工作流程中，医生需要将来自不同来源（如口述、纸质报告、电子文档）的患者数据录入到系统中。这个过程存在以下痛点：

- **效率低下**: 手动从Word、Excel或PDF报告中复制粘贴数据，耗时且枯燥。
- **易于出错**: 手动录入容易产生笔误或格式错误，影响数据质量。
- **格式不一**: 不同文档、不同医生的记录风格各异，导致数据非结构化，难以直接入库。
- **信息遗漏**: 在繁杂的报告中，部分关键信息可能被遗漏。

本方案旨在设计一个智能数据录入Agent，作为医生的得力助手，解决上述问题。

## 2. 第一性原理分析 (First Principles)

让我们回归问题的本质，构建解决方案。

- **根本目标是什么？**
  > 将任何格式（手动输入、Word、Excel）的患者信息，高效、准确地转换为结构化数据，并存入数据库中对应的患者名下。

- **实现该目标最核心的要素有哪些？**
  1.  **接收端 (Input)**: 必须有一个界面，能让医生输入文字或上传文件。
  2.  **解析器 (Parser)**: 必须有能力“读懂”不同格式的文件，把Word的段落、Excel的单元格都转换成机器可处理的文本/数据。
  3.  **映射器 (Mapper)**: 这是Agent的“大脑”。它必须能理解“血糖”这个词对应的是数据库里的 `glucose_value` 字段，或者“张三”这个名字应该放入 `patient_name` 字段。
  4.  **验证器 (Validator)**: 必须能检查映射后的数据是否合理，例如血糖值不能是负数，日期格式必须正确。
  5.  **确认机制 (Confirmer)**: 在自动处理后，必须提供一个界面让医生最终确认映射结果是否正确，确保100%的准确性。
  6.  **存储器 (Storage)**: 必须能根据患者ID，将确认无误的数据存入正确的数据库表中。

## 3. 解决方案架构

基于以上分析，我们设计一个包含“前端交互界面”和“后端智能服务”的系统架构。

### 3.1 前端交互界面 (UI Layer)

构建一个统一的数据录入页面，包含以下模块：

- **患者ID输入框**: 录入数据的首要步骤，用于锁定目标患者。
- **文件上传区**: 支持拖拽或点击上传 `.docx` 和 `.xlsx` 文件。
- **手动录入区**: 一个富文本编辑器，医生可以直接将文本粘贴进来，或进行手动输入。
- **智能解析与预览区**: 当数据输入或上传后，此区域会**实时显示Agent的解析和映射结果**。例如：
    - 左侧显示原始文本：“患者张三，男，今日空腹血糖值为6.5mmol/L”。
    - 右侧显示Agent的解析结果（一个表单）:
        - `patient_name`: [ 张三 ]
        - `gender`: [ 男 ]
        - `glucose_value`: [ 6.5 ]
        - `glucose_type`: [ 空腹 ]
- **确认与修正**: 医生可以快速核对右侧表单中的值，如果发现错误，可以直接在表单中修正。
- **提交按钮**: 点击后，将最终确认的数据发送给后端存入数据库。

### 3.2 后端智能服务 (Agent Logic)

这是Agent的核心，负责处理前端发送过来的原始数据。

- **API 接口**: 设计一个 `/api/v1/data-entry/parse` 接口，接收前端的文本或文件。

- **文件解析服务 (Parser Service)**:
  - **Excel解析**: 使用 `xlsx` 或 `exceljs` 库，读取表格内容，将其转换为二维数组或JSON对象。
  - **Word解析**: 使用 `mammoth.js` 或 `docx` 库，提取文档中的段落、标题和表格数据，转换为纯文本或Markdown格式。

- **智能映射服务 (Mapper Service) - Agent大脑**:
  - **步骤1: 实体识别 (Entity Recognition)**: 从解析后的文本中识别出关键信息点。例如，识别出“6.5mmol/L”是一个血糖值，“2025-08-15”是一个日期。
  - **步骤2: 字段映射 (Field Mapping)**: 将识别出的实体，与数据库字段进行匹配。这是通过一个“知识库”实现的：
    - **关键词词典**: 维护一个JSON词典，如 `{"姓名": "name", "性别": "gender", "空腹血糖": "fpg", "餐后血糖": "ppg", ...}`。通过关键词匹配进行初步映射。
    - **正则表达式**: 对特定格式的数据（如身份证号、日期、电话号码）使用正则表达式进行精准提取和验证。
    - **上下文关联**: 分析关键词周围的文本来确定其具体含义。例如，数字“7.0”后面跟着“mmol/L”，则判断为血糖值。
  - **(可选) 高级方案 - LLM集成**: 对于极其不规范的文本（如医生手写的大段描述），可以将文本块发送给大语言模型（LLM），并给出指令：“请从以下文本中，根据这些可用字段（`name`, `fpg`, `ppg`...），提取信息并以JSON格式返回。”

- **数据持久化服务 (Persistence Service)**:
  - 接收前端最终确认的JSON数据。
  - 根据 `patientId`，将数据准确存入数据库对应的表中。

### 3.2.4 LLM集成策略 (Advanced Mapping with LLM)

为了处理高度非结构化、难以通过关键词或正则表达式精确提取的文本（如医生手写的大段描述、复杂的病史摘要），我们将引入大语言模型（LLM）进行辅助。

-   **目的**: 提升Agent对复杂、模糊文本的理解能力和数据提取的准确性。
-   **工作流程**:
    1.  **前置处理**: 原始文本首先经过现有的关键词和正则表达式映射器进行初步处理。
    2.  **LLM调用条件**: 如果经过初步处理后，仍有大量未映射的关键信息，或者文本被系统识别为高度非结构化（例如，通过文本长度、关键词密度、句法复杂度等判断），则触发LLM调用。
    3.  **Prompt工程**: 这是LLM集成的核心。我们将精心设计Prompt，包含：
        -   **角色设定**: 指导LLM扮演一个专业的医疗数据提取助手。
        -   **任务描述**: 明确告知LLM需要从文本中提取哪些信息。
        -   **可用字段列表**: 提供一个明确的数据库字段列表（例如 `patientName`, `glucoseValue`, `dateOfBirth` 等），指导LLM将提取的信息映射到这些字段。
        -   **输出格式**: 强制LLM以结构化的JSON格式返回结果，例如：
            ```json
            {
              "patientName": "张三",
              "glucoseValue": 6.5,
              "dateOfBirth": "1990-01-01"
            }
            ```
        -   **示例**: 提供少量高质量的输入-输出示例（Few-shot learning），帮助LLM更好地理解任务。
        -   **错误处理**: 指导LLM在无法确定某个字段时返回 `null` 或空字符串，而不是猜测。
    4.  **LLM响应处理**: 后端服务接收LLM返回的JSON数据，进行二次验证和清洗，然后与初步映射的数据合并。
    5.  **数据持久化**: 最终的结构化数据存入数据库。
-   **技术选型考虑**:
    -   **LLM提供商**: 考虑Google Gemini, OpenAI GPT, 或其他符合数据安全和隐私要求的本地部署模型。
    -   **API集成**: 通过HTTP请求调用LLM的API。
-   **挑战与考量**:
    -   **成本**: LLM API调用可能产生费用，需要考虑成本优化策略（如缓存、批量处理）。
    -   **延迟**: LLM响应时间可能较长，需要异步处理或优化用户体验。
    -   **数据隐私与安全**: 确保敏感医疗数据在传输和处理过程中符合隐私法规。
    -   **准确性与幻觉**: LLM可能产生“幻觉”，需要设计额外的验证机制来确保提取数据的准确性。

## 4. 开发路线图

建议分阶段、迭代式开发：

- **第一阶段：MVP (最小可行产品)** (1-2周)
  1.  **后端API实现 (已完成)**:
      -   创建了 `data-entry` NestJS模块 (`server/src/modules/data-entry/`)。
      -   实现了 `/api/v1/data-entry/parse` POST接口，用于接收文本数据。
      -   集成了基于关键词的文本解析逻辑 (`DataEntryService`)。
      -   实现了数据持久化功能，解析后的结构化数据会保存到 `parsed_data` 表中。
  2.  搭建前端页面框架，包含患者ID输入、手动录入框和结果预览区。
      -   **当前阻塞**: 尝试安装前端HTTP客户端 `axios` 时，遇到 `E401 Unauthorized` 错误，指向私有npm注册表认证失败。此问题需在继续前端开发前解决。
  3.  实现后端`关键词词典`映射，支持手动粘贴文本的解析和预览。
  4.  完成手动确认和数据入库的完整流程。

- **第二阶段：文件解析** (1周)
  1.  集成Excel文件解析功能。
  2.  集成Word文件解析功能。

- **第三阶段：智能优化** (2周+)
  1.  引入正则表达式，提升对特定数据格式的识别准确率。
  2.  优化上下文关联逻辑。
  3.  (可选) 调研并集成LLM，处理疑难、非结构化文本。

## 5. 技术栈建议

- **前端**: 沿用项目现有技术栈 (React/Vue)。
- **后端**: 
  - **主服务**: 沿用项目现有Node.js服务，用于处理API请求和文件上传。
  - **AI映射服务**: 考虑到未来可能引入复杂的NLP或LLM，建议将“智能映射服务”作为一个独立的Python微服务（使用Flask/FastAPI），主服务通过内部API调用它。这能实现技术栈解耦，便于未来扩展。
- **关键库**: 
  - **Node.js**: `axios`, `multer` (用于文件上传), `xlsx`, `mammoth`。
  - **Python**: `Flask`, `spaCy` (用于实体识别), `pandas`。
